{% extends 'base.html' %}
{% load static %}

{% block title %}Рейтинг игроков - Теннисная Лига{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">
        <i class="bi bi-trophy-fill text-warning"></i> Рейтинг игроков
    </h1>
    
    <!-- Топ-10 Диаграмма -->
    {% if top_10_players %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-gradient-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-graph-up"></i> ТОП-10 игроков
            </h5>
        </div>
        <div class="card-body">
            <canvas id="top10Chart" height="80"></canvas>
        </div>
    </div>
    {% endif %}
    
    <!-- Фильтры -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-funnel"></i> Фильтры
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Пол</label>
                    <select name="gender" class="form-select">
                        <option value="">Все</option>
                        <option value="M" {% if request.GET.gender == 'M' %}selected{% endif %}>Мужчины</option>
                        <option value="F" {% if request.GET.gender == 'F' %}selected{% endif %}>Женщины</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Уровень NTRP</label>
                    <select name="level" class="form-select">
                        <option value="">Все уровни</option>
                        <option value="1.5" {% if request.GET.level == '1.5' %}selected{% endif %}>1.5</option>
                        <option value="2.0" {% if request.GET.level == '2.0' %}selected{% endif %}>2.0</option>
                        <option value="2.5" {% if request.GET.level == '2.5' %}selected{% endif %}>2.5</option>
                        <option value="3.0" {% if request.GET.level == '3.0' %}selected{% endif %}>3.0</option>
                        <option value="3.5" {% if request.GET.level == '3.5' %}selected{% endif %}>3.5</option>
                        <option value="4.0" {% if request.GET.level == '4.0' %}selected{% endif %}>4.0</option>
                        <option value="4.5" {% if request.GET.level == '4.5' %}selected{% endif %}>4.5</option>
                        <option value="5.0" {% if request.GET.level == '5.0' %}selected{% endif %}>5.0+</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Город</label>
                    <input type="text" name="city" class="form-control" placeholder="Москва" value="{{ request.GET.city }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Мин. матчей</label>
                    <input type="number" name="min_matches" class="form-control" placeholder="0" value="{{ request.GET.min_matches }}" min="0">
                </div>
                <div class="col-md-12 text-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Применить фильтр
                    </button>
                    <a href="{% url 'rating_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Сбросить
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Таблица рейтинга -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">Место</th>
                            <th>Игрок</th>
                            <th>Город</th>
                            <th style="width: 80px;">NTRP</th>
                            <th style="width: 100px;">Очки</th>
                            <th style="width: 80px;">Матчей</th>
                            <th style="width: 80px;">Побед</th>
                            <th style="width: 100px;">% побед</th>
                            <th style="width: 100px;">Турниров</th>
                            <th style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rating in ratings %}
                        <tr {% if rating.user == user %}class="table-info"{% endif %}>
                            <td class="text-center">
                                {% if rating.rank_position <= 3 %}
                                    <div class="position-medal" style="font-size: 1.5rem;">
                                        {% if rating.rank_position == 1 %}
                                            <i class="bi bi-award-fill text-warning"></i>
                                        {% elif rating.rank_position == 2 %}
                                            <i class="bi bi-award-fill" style="color: silver;"></i>
                                        {% else %}
                                            <i class="bi bi-award-fill" style="color: #cd7f32;"></i>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <strong class="text-muted">#{{ rating.rank_position }}</strong>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if rating.user.photo %}
                                        <img src="{{ rating.user.photo.url }}" class="rounded-circle me-2 border border-2" 
                                             style="width: 45px; height: 45px; object-fit: cover;" alt="{{ rating.user.username }}">
                                    {% else %}
                                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" 
                                             style="width: 45px; height: 45px; font-size: 1.2rem; font-weight: bold;">
                                            {{ rating.user.username|slice:":1"|upper }}
                                        </div>
                                    {% endif %}
                                    <div>
                                        <div>
                                            <strong>{{ rating.user.get_full_name|default:rating.user.username }}</strong>
                                            {% if rating.user == user %}
                                                <span class="badge bg-info ms-1">Вы</span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">@{{ rating.user.username }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if rating.user.city %}
                                    <i class="bi bi-geo-alt"></i> {{ rating.user.city }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ rating.ntrp_level }}</span>
                            </td>
                            <td>
                                <strong style="font-size: 1.1rem; color: #007bff;">{{ rating.points }}</strong>
                            </td>
                            <td class="text-center">{{ rating.matches_played }}</td>
                            <td class="text-center">
                                <span class="text-success fw-bold">{{ rating.matches_won }}</span>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar {% if rating.win_percentage >= 60 %}bg-success{% elif rating.win_percentage >= 40 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ rating.win_percentage }}%;" 
                                         aria-valuenow="{{ rating.win_percentage }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        <small class="fw-bold">{{ rating.win_percentage }}%</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                {% if rating.tournament_wins > 0 %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-trophy-fill"></i> {{ rating.tournament_wins }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <a href="{% url 'profile' rating.user.username %}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <i class="bi bi-inbox" style="font-size: 3rem; color: #ddd;"></i>
                                <p class="text-muted mt-3 mb-0">Игроки не найдены</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Пагинация -->
            {% if is_paginated %}
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if request.GET.gender %}&gender={{ request.GET.gender }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.city %}&city={{ request.GET.city }}{% endif %}{% if request.GET.min_matches %}&min_matches={{ request.GET.min_matches }}{% endif %}">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.gender %}&gender={{ request.GET.gender }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.city %}&city={{ request.GET.city }}{% endif %}{% if request.GET.min_matches %}&min_matches={{ request.GET.min_matches }}{% endif %}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">{{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.gender %}&gender={{ request.GET.gender }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.city %}&city={{ request.GET.city }}{% endif %}{% if request.GET.min_matches %}&min_matches={{ request.GET.min_matches }}{% endif %}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.gender %}&gender={{ request.GET.gender }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.city %}&city={{ request.GET.city }}{% endif %}{% if request.GET.min_matches %}&min_matches={{ request.GET.min_matches }}{% endif %}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Chart.js для графика топ-10 -->
{% if top_10_players %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const ctx = document.getElementById('top10Chart');
    const top10Data = [
        {% for rating in top_10_players %}
            {
                name: "{{ rating.user.get_full_name|default:rating.user.username|escapejs }}",
                points: {{ rating.points }},
                matches: {{ rating.matches_played }},
                wins: {{ rating.matches_won }}
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top10Data.map((item, index) => `#${index + 1} ${item.name}`),
            datasets: [{
                label: 'Рейтинговые очки',
                data: top10Data.map(item => item.points),
                backgroundColor: [
                    'rgba(255, 193, 7, 0.8)',   // gold
                    'rgba(192, 192, 192, 0.8)', // silver
                    'rgba(205, 127, 50, 0.8)',  // bronze
                    'rgba(0, 123, 255, 0.6)',
                    'rgba(0, 123, 255, 0.6)',
                    'rgba(0, 123, 255, 0.6)',
                    'rgba(0, 123, 255, 0.6)',
                    'rgba(0, 123, 255, 0.6)',
                    'rgba(0, 123, 255, 0.6)',
                    'rgba(0, 123, 255, 0.6)'
                ],
                borderColor: [
                    'rgba(255, 193, 7, 1)',
                    'rgba(192, 192, 192, 1)',
                    'rgba(205, 127, 50, 1)',
                    'rgba(0, 123, 255, 1)',
                    'rgba(0, 123, 255, 1)',
                    'rgba(0, 123, 255, 1)',
                    'rgba(0, 123, 255, 1)',
                    'rgba(0, 123, 255, 1)',
                    'rgba(0, 123, 255, 1)',
                    'rgba(0, 123, 255, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const index = context.dataIndex;
                            const player = top10Data[index];
                            return [
                                `Очки: ${player.points}`,
                                `Матчей: ${player.matches}`,
                                `Побед: ${player.wins}`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + ' очков';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
</script>
{% endif %}

<style>
    .card {
        border: none;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
    
    .table thead th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        transform: translateX(5px);
        background-color: #f8f9fa !important;
    }
</style>
{% endblock %}
